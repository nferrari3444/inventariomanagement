{% extends '_base.html' %}

<head>
{% load static %}

</head>

{% block content %}


<!-- sm:col-span-2 -->
<section class="bg-white dark:bg-gray-900">
    <div class="py-8 px-4 mx-auto max-w-3xl lg:py-16">
        <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">Solicitud Ingreso de Nuevos Productos</h2>
        <form id="forms" action="{% url 'inbound' %}" method="POST">
            {% csrf_token %}

                {{form.extra_field_count}}
       
            <div class="grid gap-4 sm:grid-cols-2 sm:gap-6">
                <!-- <div>
                    <label for="productname" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{{form.product.label_tag}}</label>
                      <<select  name="productname" id="productname" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"> 
                      
                         <option value="Seleccionar Producto" selected="selected"></option> 
                    </select> 
                    {{form.product}} 
                    </div> -->
                <div class="w-full">
                    <label for="brand" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Depósito</label>
                    {{form.warehouse}}
                    <!-- <input type="date" name="date" id="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Ingresar Fecha" required="">
                     -->
                       
                    </div>
                <!-- <div class="w-full">
                    <label for="price" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Código de Barras</label>
                     <input type="number" name="barcode" id="barcode" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="$2999" required=""> 
                       
                </div> -->
                <div>
                    <label for="motivoIngreso" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Motivo Ingreso</label>
                    {{form.motivoIngreso}}
                </div>
                <!-- <div>
                    <label for="item-weight" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Código Interno</label>
                     <input type="number" name="internal-code" id="internal-code" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="12" required=""> 
                 
                </div>  -->
                <div>
                    <label for="motivoIngreso" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Departamento</label>
                    {{form.department}}
                </div>

                <div>
                    <label for="receptor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Receptor</label>
                    {{form.receptor}}

                   
                </div>

                <div>
                    <label for="receptor" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Solicitante</label>
                    {{form.issuer}}

                   
                </div>

                <div>
                    <label for="date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha</label>
                    {{form.date}}

                   
                </div>

            </div>

                
            <div class="max-w-4xl mt-10">
            <table id="productTable" class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col-span-2" class="px-6 py-3">
                            Producto
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Código de Barras                    
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Código Interno
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Cantidad
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                        <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                         
                           
                             <label for="productname" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"></label>
                            <input type="text" id="productname" +   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="John" required> 
                            
                        
                        </th>
                        <td class="px-6 py-4">
                            <input type="text" id="barcode" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="John" required>
                        </td>
                        <td class="px-6 py-4">
                            <input type="text" id="internal-code" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="John" required>
                        </td>
                        <td class="px-6 py-4">
                            {{form.cantidad}}
                        </td>

                        

                    </tr> -->
                 
                </tbody>
             
            </table>
            <td class="px-6 py-4">
                <button  id="add-product" class="inline-flex items-center px-3 py-1.5 mt-2 sm:mt-6 text-sm font-medium text-center text-white bg-primary-700 rounded-lg focus:ring-4 focus:ring-primary-200 dark:focus:ring-primary-900 hover:bg-primary-800">
                    Add New Product
                 </button>

                 <button  id="remove-product" class="inline-flex items-center px-3 py-1.5 mt-2 sm:mt-6 text-sm font-medium text-center text-white bg-primary-700 rounded-lg focus:ring-4 focus:ring-primary-200 dark:focus:ring-primary-900 hover:bg-primary-800">
                    Remove Product
                 </button>

            </td>
        </div>

                
        <div class="sm:col-span-2">
            <label for="description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observaciones</label>
            <textarea id="description" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Your description here"></textarea>
        
        </div>
            
            
            <button type="submit" id='nuevoIngreso' class="inline-flex items-center px-5 py-2.5 mt-4 sm:mt-6 text-sm font-medium text-center text-white bg-primary-700 rounded-lg focus:ring-4 focus:ring-primary-200 dark:focus:ring-primary-900 hover:bg-primary-800">
                Confirma Solicitud Ingreso
            </button>
        </div>
           
        </form>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger">
        {{ form.errors }}
    </div>
{% endif %}

  </section>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/datepicker.min.js"></script>


<script>

let form_count = Number($("[name=extra_field_count]").val());
console.log('form_count is ', form_count)
$("#add-product").click(function(event) {
    
    event.preventDefault()
// get extra form count so we know what index to use for the next item
    console.log(event.target.value)
   
    var table = document.getElementById('productTable')
    var lastRow = table.rows[ table.rows.length - 1 ];
    var product = lastRow.cells[0].firstElementChild
    var quantity = lastRow.cells[3].firstElementChild
    
    console.log('product first Round', product)
    console.log('quantity first Round', quantity)


    if (form_count >0) {
        console.log('form_count', form_count)

        var table = document.getElementById('productTable')
    var lastRow = table.rows[ table.rows.length - 1 ];
    var product = lastRow.cells[0].firstElementChild.value
    var quantity = lastRow.cells[3].firstElementChild.value
    
    console.log('product second Round', product)
    console.log('quantity second Round', quantity)

    if (product === '') {

        alert('Ingresar un Nuevo Producto')
        return
    }

    if (quantity === '') {

    alert('Ingresar la cantidad comprada del Producto')
            return
    }

    }


    var newRow = document.getElementById('productTable').insertRow();

    
    var newCell = newRow.insertCell();

    
    newCell.innerHTML=  `<tr><td><input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" type="text" id="productname_${form_count}" name="product_${form_count}" placeholder="producto" required></td></tr>`;

    newCell = newRow.insertCell();
    newCell.innerHTML=`<tr><td><input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" type='text' id="barcode_${form_count}" name="barcode_${form_count}" placeholder="barcode" required></td></tr>`;

    newCell = newRow.insertCell();
    newCell.innerHTML=`<tr><td><input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" type='text' id="internal-code_${form_count}" name="internalCode_${form_count}" placeholder="internalCode" required></td></tr>`;

    newCell = newRow.insertCell();
    newCell.innerHTML= `<tr><td><input type = "number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" type='text' id="cantidad_${form_count}" name="cantidad_${form_count}" placeholder="cantidad" required></td></tr>`; 

    $(`#productname_${form_count}`).autocomplete({
        source: '{% url "autocomplete-name" %}',
        minLength:1,
        select: function(event, ui) {
                    //  console.log(ui)
                 $(`#productname_${form_count}`).val(ui.item.value)

                let product = ui.item.value
                console.log('product',product)
                var dataLS = JSON.parse(localStorage.getItem('products'))

                // console.log('dataLS', dataLS)

                // console.log('productSelected', dataLS[String(product)])

                var productId = dataLS[product]

                console.log('productId',productId)

                request_url = '/product/' + productId + '/';
                $.ajax({
                    url: request_url,
                    success: function(data){
                        console.log('data.product',data.product)
                    let barcode = data.product[0][0]
                    let internalCode = data.product[0][1]
                     console.log(barcode)

                     console.log(internalCode)
                     console.log('form_count is', form_count)
                    $(`#barcode_${form_count -1}`).val(barcode)
                    $(`#internal-code_${form_count -1 }`).val(internalCode)
//             $('productname').attr('')
           }
        });

    }})

    form_count ++;
    $("[name=extra_field_count]").val(form_count);

})

$("#remove-product").click(function(event) {

    event.preventDefault()
    var table = document.getElementById('productTable')
    var lastRow = table.rows[ table.rows.length - 1 ];


    lastRow.remove()
    form_count --;
    $("[name=extra_field_count]").val(form_count);

})




//     console.log('hola hola')
   $.ajax({
            url: `/products/`,
        type: 'get', 
        success: function(data) {
            // console.log(data.products)

            // console.log('llega aca')

            // console.log(data.products)

            localStorage.setItem('products', JSON.stringify(data.products))
          //  for (let i = 0 ; i< data.products.length ; i++) {
               
          //  $("#productname").append(`<option value=${data.products[i][0]}>`+ data.products[i][1] +'</option>');

        }
    })
    



</script>

{% endblock content %}